/*! BusBoardingMap 2016-04-21 */
"use strict";L.BusMain={},L.BusMain.MainPageVars={Attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',BaseMapUrl:"http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",BaseMap:void 0,MainProcess:void 0},$(function(){L.BusMain.MainPageVars.BaseMap=L.map("map",{zoomControl:!1,center:[23.1852,120.4287],zoom:11}),L.tileLayer(L.BusMain.MainPageVars.BaseMapUrl,{attribution:L.BusMain.MainPageVars.Attribution}).addTo(L.BusMain.MainPageVars.BaseMap),L.BusMain.MainPageVars.MainProcess=L.BusMain.mainprocess()}),L.BusMain.mainprocess=function(){return new L.BusMain.MainProcessor},L.BusMain.MainProcessor=L.Class.extend({initialize:function(){this._RouteController=void 0,this._SideBar=void 0,this._DateSlider=void 0,this._Legend=void 0,this._DateView=void 0,this._TotalView=void 0,this._Date={Year:"2014",Month:"Total"},this._ShowHideMask(!0),this._InitData()},_InitData:function(){var a=this;async.parallel([function(a){$.getJSON("LocalData/Config.json",function(b){a(null,b)})},function(a){$.getJSON("LocalData/Data/TotalCapacity.json",function(b){a(null,b)})},function(a){$.getJSON("LocalData/Data/Collection.json",function(b){a(null,b)})}],function(b,c){a._RouteController=L.BusMain.routeControl(c[0],function(b){null===b?(a._RouteController.SetDirection("forward"),a._RouteController.SetDate(a._Date),a._RouteController.ApplyToMap(),a._InitControls(c[0],c[1],c[2]),a._ShowHideMask(!1)):console.log("Error occured when creating layers.")})})},_InitControls:function(a,b,c){var d=this;d._Legend=L.BusMainControl.legend(a.CapacityControl,a.CapacityRange),L.BusMain.MainPageVars.BaseMap.addControl(d._Legend),d._DateView=L.BusMainControl.dateview(),L.BusMain.MainPageVars.BaseMap.addControl(d._DateView),d._DateView.ChangeValue(d._Date),d._TotalView=L.BusMainControl.ridership(b),L.BusMain.MainPageVars.BaseMap.addControl(d._TotalView),d._TotalView.ChangeValue(d._Date),d._DateSlider=L.BusMainControl.slider(function(a){d._Date=a,d._RouteController.SetDate(a),d._DateView.ChangeValue(a),d._TotalView.ChangeValue(a)},a.CapacityControl),d._DateSlider.AddWidget(),d._SideBar=L.BusMainControl.sidebar(function(a){isNaN(a.target.id)===!1&&(d._RouteController.SelectRoute(a.target.id,d._Date),d._SideBar.ChangeBtnState(a.target))},function(){d._RouteController.UnselectRoute(d._Date),d._SideBar.RevertBtnState()},c),d._SideBar.AddWidget()},_ShowHideMask:function(a){a===!0?$(".LoadingMask").css("display","initial"):$(".LoadingMask").css("display","none")}}),L.BusMain.routeControl=function(a,b){return new L.BusMain.RoutesController(a,b)},L.BusMain.RoutesController=L.Class.extend({initialize:function(a,b){this.Config=a,this.RouteLayers={},this._SelectedRoute=[],this._LoadRequireData(a.CapacityRange,b)},SelectRoute:function(a,b){this.RouteLayers[a].Select("Yes",b),this._SelectedRoute.push(this.RouteLayers[a])},UnselectRoute:function(a){if(0!==this._SelectedRoute.length){for(var b=0;b<this._SelectedRoute.length;b++)this._SelectedRoute[b].Select("No",a);this._SelectedRoute=[]}},SetDirection:function(a){if(0===Object.keys(this.RouteLayers).length)return void console.log("No Layer!");for(var b in this.RouteLayers)this.RouteLayers.hasOwnProperty(b)&&this.RouteLayers[b].SetDirection(a)},SetDate:function(a){if(0===Object.keys(this.RouteLayers).length)return void console.log("No Layer!");for(var b in this.RouteLayers)this.RouteLayers.hasOwnProperty(b)&&this.RouteLayers[b].SetDate(a)},ApplyToMap:function(){if(0===Object.keys(this.RouteLayers).length)return void console.log("No Layer!");for(var a in this.RouteLayers)this.RouteLayers.hasOwnProperty(a)&&this.RouteLayers[a].addTo(L.BusMain.MainPageVars.BaseMap)},_LoadRequireData:function(a,b){var c=this;async.waterfall([function(a){$.getJSON("LocalData/Data/Collection.json",function(b){a(null,b)}).fail(function(){a("collection_error",null)})},function(b,d){c._CreateAllRouteLayers(b,a,function(a){null===a?d(null,b):d(a,null)})}],function(a,c){b(null===a?null:a)})},_CreateAllRouteLayers:function(a,b,c){var d=this,e=[];for(var f in a)a.hasOwnProperty(f)&&e.push(f);async.each(e,function(c,e){async.each(a[c].members,function(a,c){d._DownloadEachRouteSource(a,b,function(b,e){null!==b?c(b):(d.RouteLayers[a.tags["ref:querycode"]]=e,c(null))})},function(a){e(null!==a?a:null)})},function(a){c(null!==a?a:null)})},_DownloadEachRouteSource:function(a,b,c){var d=this;async.series([function(b){$.getJSON("LocalData/Data/"+a.tags["ref:category"]+"/"+a.tags["ref:querycode"]+"/Capacity.json",function(a){b(null,a)}).fail(function(){b("capacity_error",null)})},function(b){d._DownloadDirectionSource("Forward",a,function(a,c){null!==a?b(a,null):b(null,c)})},function(b){d._DownloadDirectionSource("Backward",a,function(a,c){null!==a?b(a,null):b(null,c)})}],function(d,e){if(null===d){var f=L.BusMain.routeLayer(e[1],e[2],e[0],b);c(null,f)}else console.log(a.tags["ref:querycode"]+" DownloadEachRouteSource Error: "+d),c(d,null)})},_DownloadDirectionSource:function(a,b,c){"Forward"!==a&&"Backward"!==a||$.getJSON("LocalData/Data/"+b.tags["ref:category"]+"/"+b.tags["ref:querycode"]+"/"+a+".json",function(a){c(null,a)}).fail(function(){c(a+" direction is missing or broken.",null)})}}),L.BusMain.routeLayer=function(a,b,c,d){return new L.BusMain.RouteLayer(a,b,c,d)},L.BusMain.RouteLayer=L.LayerGroup.extend({initialize:function(a,b,c,d){L.FeatureGroup.prototype.initialize.call(this),this.ForwardPolylines=this._FormatPolyline(a),this.BackwardPolylines=this._FormatPolyline(b),this.CapacityJson=c,this.ColourRangeJson=d,this.IsRouteSelected=!1},Select:function(a,b){var c,d=this._GetRange(this.ColourRangeJson,this.CapacityJson,b),e=this.getLayers();if(e.length>0){"Yes"===a?(c=d.SelectedColour,this.IsRouteSelected=!0):"No"===a&&(c=d.Colour,this.IsRouteSelected=!1);for(var f=0;f<e.length;f++)e[f].setStyle({color:c})}},SetDirection:function(a){if(this.clearLayers(),"forward"===a)for(var b=0;b<this.ForwardPolylines.length;b++)this.addLayer(this.ForwardPolylines[b]);else if("backward"===a)for(var c=0;c<this.BackwardPolylines.length;c++)this.addLayer(this.BackwardPolylines[c])},SetDate:function(a){var b=this._GetRange(this.ColourRangeJson,this.CapacityJson,a),c=this.getLayers();c.length>0&&this._ChangeColour(b,c)},_FormatPolyline:function(a){for(var b=[],c=0;c<a.length;c++)if("way"===a[c].type){var d=L.polyline(a[c].geometry,{color:"#C7C7C7",weight:5,clickable:!1});b.push(d)}return b},_ChangeColour:function(a,b){var c;c=this.IsRouteSelected===!0?a.SelectedColour:a.Colour;for(var d=0;d<b.length;d++)b[d].setStyle({color:c,weight:a.Width});return this},_GetRange:function(a,b,c){var d;if(void 0===b[c.Year])d=this._GetZeroCapacityColour(a);else{var e=b[c.Year][c.Month];if(0===parseInt(e))d=this._GetZeroCapacityColour(a);else for(var f=0;f<a.length;f++)if(e<a[f].MaxCapacity&&e>a[f].MinCapacity){d={Colour:a[f].ColourCode,SelectedColour:a[f].SelectedColourCode,Width:a[f].Width};break}}return d},_GetZeroCapacityColour:function(a){for(var b,c=0;c<a.length;c++)if(0===a[c].MaxCapacity&&0===a[c].MinCapacity){b={Colour:a[c].ColourCode,HightlightColour:a[c].HightlightColourCode};break}return b}});