/*! BusBoardingMap 2016-06-03 */
"use strict";L.BusMain={},L.BusMain.MainPageVars={Attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',BaseMapUrl:"http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",BaseMap:void 0,MainProcess:void 0},$(function(){L.BusMain.MainPageVars.BaseMap=L.map("map",{zoomControl:!1,center:[23.1852,120.4287],zoom:11}),L.tileLayer(L.BusMain.MainPageVars.BaseMapUrl,{attribution:L.BusMain.MainPageVars.Attribution}).addTo(L.BusMain.MainPageVars.BaseMap),L.BusMain.MainPageVars.MainProcess=L.BusMain.mainprocess()}),L.BusMain.mainprocess=function(){return new L.BusMain.MainProcessor},L.BusMain.MainProcessor=L.Class.extend({initialize:function(){this._RouteController=void 0,this._SideBar=void 0,this._DateSlider=void 0,this._Legend=void 0,this._DateView=void 0,this._TotalView=void 0,this._RouteLegend=void 0,this._ZoomControl=void 0,this._Date={Year:"2014",Month:"Total"},this._ShowHideMask(!0),this._InitData()},_InitData:function(){async.parallel([function(a){$.getJSON("LocalData/Config.json",function(b){a(null,b)})},function(a){$.getJSON("LocalData/Data/TotalCapacity.json",function(b){a(null,b)})},function(a){$.getJSON("LocalData/Data/Collection.json",function(b){a(null,b)})}],function(a,b){this._RouteController=L.BusMain.routeControl(b[2],b[0],function(a){null===a?(this._RouteController.SetDirection("forward"),this._RouteController.SetDate(this._Date),this._RouteController.ApplyToMap(),this._InitControls(b[0],b[1],b[2]),this._ShowHideMask(!1)):console.log("Error occured when creating layers.")}.bind(this))}.bind(this))},_InitControls:function(a,b,c){this._Legend=L.BusMainControl.legend(a.CapacityControl,a.CapacityRange),L.BusMain.MainPageVars.BaseMap.addControl(this._Legend),this._DateView=L.BusMainControl.dateview(),L.BusMain.MainPageVars.BaseMap.addControl(this._DateView),this._DateView.ChangeValue(this._Date),this._TotalView=L.BusMainControl.ridership(b),L.BusMain.MainPageVars.BaseMap.addControl(this._TotalView),this._TotalView.ChangeValue(this._Date,null),this._ZoomControl=L.control.zoom({position:"bottomright"}),L.BusMain.MainPageVars.BaseMap.addControl(this._ZoomControl),this._RouteLegend=L.BusMainControl.routelegend(),this._RouteLegend.ChangeText(null),this._DateSlider=L.BusMainControl.slider(function(a){this._Date=a,this._RouteController.SetDate(a),this._DateView.ChangeValue(a);var b;this._RouteController.IsHasSelecetedRoute()===!0&&(b=this._RouteController.GetRouteCapacity()),this._TotalView.ChangeValue(a,b)}.bind(this),a.CapacityControl),this._DateSlider.AddWidget(),this._DateControl=L.BusMainControl.controlBtns(function(a){void 0!==this._DateSlider&&("Next"===a?this._DateSlider.SetSliderValue(!0):"Previous"===a?this._DateSlider.SetSliderValue(!1):"PlayPasue"===a&&(this._DateControl.CheckisPlaying()===!0?this._IntervalID=setInterval(function(){this._DateSlider.SetSliderValue(!0)}.bind(this),1e3):this._DateControl.CheckisPlaying()===!1&&clearInterval(this._IntervalID)))}.bind(this),a.CapacityControl),this._DateControl.AddWidget(),this._SideBar=L.BusMainControl.sidebar(function(a){this._RemoveSelectedRoute(),isNaN(a.target.id)===!1&&this._AddSelectedRoute(a)}.bind(this),function(){this._RouteController.IsHasSelecetedRoute()===!0&&this._RemoveSelectedRoute()}.bind(this),c),this._SideBar.AddWidget()},_ShowHideMask:function(a){a===!0?$(".LoadingMask").css("display","initial"):$(".LoadingMask").css("display","none")},_RemoveSelectedRoute:function(){this._RouteController.UnselectRoute(this._Date),this._SideBar.RevertBtnState(),this._TotalView.ChangeValue(this._Date,null),this._RouteLegend.ChangeText(null)},_AddSelectedRoute:function(a){if(isNaN(a.target.id)===!1){this._RouteController.SelectRoute(a.target.id,this._Date),L.BusMain.MainPageVars.BaseMap.fitBounds(this._RouteController.GetRouteBound(a.target.id));var b=this._RouteController.GetRouteCapacity(),c=this._RouteController.GetRouteTags();this._SideBar.ChangeBtnState(a.target),this._TotalView.ChangeValue(this._Date,b),this._RouteLegend.ChangeText(c)}}}),L.BusMain.routeControl=function(a,b,c){return new L.BusMain.RoutesController(a,b,c)},L.BusMain.RoutesController=L.Class.extend({initialize:function(a,b,c){this.Config=b,this.RouteLayers={},this._SelectedRoute=null,this._SelectedRouteCode=0,this._CreateAllRouteLayers(a,b.CapacityRange,c)},IsHasSelecetedRoute:function(){return null!==this._SelectedRoute},SelectRoute:function(a,b){this.RouteLayers[a].Select("Yes",b),this.RouteLayers[a].bringToFront(),this._SelectedRouteCode=a,this._SelectedRoute=this.RouteLayers[a]},UnselectRoute:function(a){null!==this._SelectedRoute&&(this._SelectedRoute.Select("No",a),this._SelectedRoute.bringToBack(),this._SelectedRouteCode=0,this._SelectedRoute=null)},GetRouteBound:function(a){return this.RouteLayers[a].getBounds()},GetRouteCapacity:function(){return this.RouteLayers[this._SelectedRouteCode].GetCapacityJson()},GetRouteTags:function(){return this.RouteLayers[this._SelectedRouteCode].GetRouteTags()},SetDirection:function(a){if(0===Object.keys(this.RouteLayers).length)return void console.log("No Layer!");for(var b in this.RouteLayers)this.RouteLayers.hasOwnProperty(b)&&this.RouteLayers[b].SetDirection(a)},SetDate:function(a){if(0===Object.keys(this.RouteLayers).length)return void console.log("No Layer!");for(var b in this.RouteLayers)this.RouteLayers.hasOwnProperty(b)&&this.RouteLayers[b].SetDate(a)},ApplyToMap:function(){if(0===Object.keys(this.RouteLayers).length)return void console.log("No Layer!");for(var a in this.RouteLayers)this.RouteLayers.hasOwnProperty(a)&&this.RouteLayers[a].addTo(L.BusMain.MainPageVars.BaseMap)},_CreateAllRouteLayers:function(a,b,c){var d=[];for(var e in a)a.hasOwnProperty(e)&&d.push(e);async.each(d,function(c,d){async.each(a[c].members,function(a,c){this._DownloadEachRouteSource(a,b,function(b,d){null!==b?c(b):(this.RouteLayers[a.tags["ref:querycode"]]=d,c(null))}.bind(this))}.bind(this),function(a){d(null!==a?a:null)})}.bind(this),function(a){c(null!==a?a:null)})},_DownloadEachRouteSource:function(a,b,c){async.series([function(b){$.getJSON("LocalData/Data/"+a.tags["ref:category"]+"/"+a.tags["ref:querycode"]+"/Capacity.json",function(a){b(null,a)}).fail(function(){b("capacity_error",null)})},function(b){$.getJSON("LocalData/Data/"+a.tags["ref:category"]+"/"+a.tags["ref:querycode"]+"/Geometry.json",function(a){b(null,a)}).fail(function(){b("Geometry is missing or broken.",null)})}.bind(this)],function(d,e){if(null===d){var f=L.BusMain.routeLayer(e[1],e[0],b,a.tags);c(null,f)}else console.log(a.tags["ref:querycode"]+" DownloadEachRouteSource Error: "+d),c(d,null)})}}),L.BusMain.routeLayer=function(a,b,c,d){return new L.BusMain.RouteLayer(a,b,c,d)},L.BusMain.RouteLayer=L.FeatureGroup.extend({initialize:function(a,b,c,d){L.FeatureGroup.prototype.initialize.call(this),this._ForwardPolylines=this._FormatPolyline(a.Forward),this._BackwardPolylines=this._FormatPolyline(a.Backward),this._CapacityJson=b,this._ColourRangeJson=c,this._IsRouteSelected=!1,this._RouteTags=d},GetCapacityJson:function(){return this._CapacityJson},GetRouteTags:function(){return this._RouteTags},Select:function(a,b){var c,d=this._GetRange(this._ColourRangeJson,this._CapacityJson,b),e=this.getLayers(),f=.5;if(e.length>0){"Yes"===a?(c=d.SelectedColour,f=1,this._IsRouteSelected=!0):"No"===a&&(c=d.Colour,f=.5,this._IsRouteSelected=!1);for(var g=0;g<e.length;g++)e[g].setStyle({color:c,opacity:f})}},SetDirection:function(a){if(this.clearLayers(),"forward"===a)for(var b=0;b<this._ForwardPolylines.length;b++)this.addLayer(this._ForwardPolylines[b]);else if("backward"===a)for(var c=0;c<this._BackwardPolylines.length;c++)this.addLayer(this._BackwardPolylines[c])},SetDate:function(a){var b=this._GetRange(this._ColourRangeJson,this._CapacityJson,a),c=this.getLayers();c.length>0&&this._ChangeColour(b,c)},_FormatPolyline:function(a){for(var b=[],c=0;c<a.length;c++)if("way"===a[c].type){var d=L.polyline(a[c].geometry,{color:"#C7C7C7",weight:5,clickable:!1});b.push(d)}return b},_ChangeColour:function(a,b){var c;c=this._IsRouteSelected===!0?a.SelectedColour:a.Colour;for(var d=0;d<b.length;d++)b[d].setStyle({color:c,weight:a.Width});return this},_GetRange:function(a,b,c){var d;if(void 0===b[c.Year])d=this._GetZeroCapacityColour(a);else{var e=b[c.Year][c.Month];if(0===parseInt(e))d=this._GetZeroCapacityColour(a);else for(var f=0;f<a.length;f++)if(e<a[f].MaxCapacity&&e>a[f].MinCapacity){d={Colour:a[f].ColourCode,SelectedColour:a[f].SelectedColourCode,Width:a[f].Width};break}}return d},_GetZeroCapacityColour:function(a){for(var b,c=0;c<a.length;c++)if(0===a[c].MaxCapacity&&0===a[c].MinCapacity){b={Colour:a[c].ColourCode,SelectedColour:a[c].SelectedColourCode,Width:a[c].Width};break}return b}});