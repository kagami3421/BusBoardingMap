/*! BusBoardingMap 2016-03-30 */
"use strict";L.BusMain={};var MainPageVars={Attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',BaseMapUrl:"http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",BaseMap:void 0,MainProcess:void 0};$(function(){MainPageVars.BaseMap=L.map("map",{zoomControl:!1,center:[23.1852,120.4287],zoom:11}),L.tileLayer(MainPageVars.BaseMapUrl,{attribution:MainPageVars.Attribution}).addTo(MainPageVars.BaseMap),MainPageVars.MainProcess=L.BusMain.mainprocess()}),L.BusMain.mainprocess=function(){return new L.BusMain.MainProcessor},L.BusMain.MainProcessor=L.Class.extend({initialize:function(){this._RouteController=void 0,this._DateSlider=void 0,this._Legend=void 0,this._DateView=void 0,this._TotalView=void 0,this._InitDate={Year:"2014",Month:"Total"},this._ShowHideMask(!0),this._InitData()},_InitData:function(){var a=this;async.parallel([function(a){$.getJSON("LocalData/Config.json",function(b){a(null,b)})},function(a){$.getJSON("LocalData/Data/TotalCapacity.json",function(b){a(null,b)})}],function(b,c){a._RouteController=L.BusMain.routeControl(c[0],function(b){null===b?(a._RouteController.SetDirection("forward"),a._RouteController.SetDate(a._InitDate),a._RouteController.ApplyToMap(),a._InitControls(c[0],c[1]),a._ShowHideMask(!1)):console.log("Error occured when creating layers.")})})},_InitControls:function(a,b){var c=this;c._Legend=L.BusMainControl.legend(a.CapacityRange),MainPageVars.BaseMap.addControl(c._Legend),c._DateView=L.BusMainControl.dateview(),MainPageVars.BaseMap.addControl(c._DateView),c._DateView.ChangeValue(c._InitDate),c._TotalView=L.BusMainControl.ridership(b),MainPageVars.BaseMap.addControl(c._TotalView),c._TotalView.ChangeValue(c._InitDate),c._DateSlider=L.BusMainControl.slider(function(a){c._RouteController.SetDate(a),c._DateView.ChangeValue(a),c._TotalView.ChangeValue(a)},a.CapacityControl),MainPageVars.BaseMap.addControl(c._DateSlider)},_ShowHideMask:function(a){a===!0?$(".LoadingMask").css("animation","fadein 2s"):$(".LoadingMask").css("animation","fadein 2s")}}),L.BusMain.routeControl=function(a,b){return new L.BusMain.RoutesController(a,b)},L.BusMain.RoutesController=L.Class.extend({initialize:function(a,b){this.Config=a,this.RouteLayers=[],this._LoadRequireData(a.CapacityRange,b)},SetDirection:function(a){if(0===this.RouteLayers.length)return void console.log("No Layer!");for(var b=0;b<this.RouteLayers.length;b++)this.RouteLayers[b].SetDirection(a)},SetDate:function(a){if(0===this.RouteLayers.length)return void console.log("No Layer!");for(var b=0;b<this.RouteLayers.length;b++)this.RouteLayers[b].SetDate(a)},ApplyToMap:function(){if(0===this.RouteLayers.length)return void console.log("No Layer!");for(var a=0;a<this.RouteLayers.length;a++)this.RouteLayers[a].addTo(MainPageVars.BaseMap)},_LoadRequireData:function(a,b){var c=this;async.waterfall([function(a){$.getJSON("LocalData/Data/Collection.json",function(b){a(null,b)}).fail(function(){a("collection_error",null)})},function(b,d){c._CreateAllRouteLayers(b,a,function(a){null===a?d(null,b):d(a,null)})}],function(a,c){b(null===a?null:a)})},_CreateAllRouteLayers:function(a,b,c){var d=this,e=[];for(var f in a)a.hasOwnProperty(f)&&e.push(f);async.each(e,function(c,e){async.each(a[c].members,function(a,c){d._DownloadEachRouteSource(a,b,function(a,b){null!==a?c(a):(d.RouteLayers.push(b),c(null))})},function(a){e(null!==a?a:null)})},function(a){c(null!==a?a:null)})},_DownloadEachRouteSource:function(a,b,c){var d=this;async.series([function(b){$.getJSON("LocalData/Data/"+a.tags["ref:category"]+"/"+a.tags["ref:querycode"]+"/Capacity.json",function(a){b(null,a)}).fail(function(){b("capacity_error",null)})},function(b){d._DownloadDirectionSource("forward",a,function(a,c){null!==a?b(a,null):b(null,c)})},function(b){d._DownloadDirectionSource("forward_extend",a,function(a,c){null!==a?b(a,null):b(null,c)})},function(b){d._DownloadDirectionSource("backward",a,function(a,c){null!==a?b(a,null):b(null,c)})},function(b){d._DownloadDirectionSource("backward_extend",a,function(a,c){null!==a?b(a,null):b(null,c)})}],function(d,e){if(null===d){var f=e[1].concat(e[2]),g=e[3].concat(e[4]),h=L.BusMain.routeLayer(f,g,e[0],b);c(null,h)}else console.log(a.tags["ref:querycode"]+" DownloadEachRouteSource Error: "+d),c(d,null)})},_DownloadDirectionSource:function(a,b,c){for(var d=0,e=0,f=[],g=0;g<b.members.length;g++)b.members[g].role===a&&d++;0===d?c(null,f):async.whilst(function(){return d>e},function(c){$.getJSON("LocalData/Data/"+b.tags["ref:category"]+"/"+b.tags["ref:querycode"]+"/"+a+"_"+e+".json",function(a){f.push(a),e++,c(null,e)}).fail(function(){c(a,null)})},function(a,b){null!==a?c(a+" direction is missing or broken.",null):c(null,f)})}}),L.BusMain.routeLayer=function(a,b,c,d){return new L.BusMain.RouteLayer(a,b,c,d)},L.BusMain.RouteLayer=L.FeatureGroup.extend({initialize:function(a,b,c,d){L.FeatureGroup.prototype.initialize.call(this),this.ForwardPolylines=this._FormatPolyline(a),this.BackwardPolylines=this._FormatPolyline(b),this.CapacityJson=c,this.ColourRangeJson=d},SetDirection:function(a){if(this.clearLayers(),"forward"===a)for(var b=0;b<this.ForwardPolylines.length;b++)this.addLayer(this.ForwardPolylines[b]);else if("backward"===a)for(var c=0;c<this.BackwardPolylines.length;c++)this.addLayer(this.BackwardPolylines[c])},SetDate:function(a){var b=this._CacaulateColourFromRange(this.ColourRangeJson,this.CapacityJson,a),c=this.getLayers();c.length>0&&this._ChangeColour(b.Colour,c)},_FormatPolyline:function(a){for(var b=[],c=0;c<a.length;c++)for(var d=0;d<a[c].elements.length;d++)if("way"===a[c].elements[d].type){var e=L.polyline(a[c].elements[d].geometry,{color:"#C7C7C7"});b.push(e)}return b},_ChangeColour:function(a,b){for(var c=0;c<b.length;c++)b[c].setStyle({color:a})},_CacaulateColourFromRange:function(a,b,c){var d;if(void 0===b[c.Year])d=this._GetZeroCapacityColour(a);else{var e=b[c.Year][c.Month];if(0===parseInt(e))d=this._GetZeroCapacityColour(a);else for(var f=0;f<a.length;f++)if(e<a[f].MaxCapacity&&e>a[f].MinCapacity){d={Colour:a[f].ColourCode,HightlightColour:a[f].HightlightColourCode};break}}return d},_GetZeroCapacityColour:function(a){for(var b,c=0;c<a.length;c++)if(0===a[c].MaxCapacity&&0===a[c].MinCapacity){b={Colour:a[c].ColourCode,HightlightColour:a[c].HightlightColourCode};break}return b}});